# Multi-AI Context System Database Schema Changes

## Overview
This document outlines the database schema changes implemented for the Multi-AI Context System feature. The changes extend the existing SQLite database to support multiple AI providers, learning concepts, context management, and enhanced user experiences.

## New Tables Added

### 1. ai_providers
Stores configuration and status for multiple AI providers.

```sql
CREATE TABLE ai_providers (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL, -- 'openai', 'claude', 'gemini', 'ollama', 'mistral'
  enabled BOOLEAN DEFAULT true,
  priority INTEGER DEFAULT 1,
  config TEXT, -- JSON configuration
  health_status TEXT DEFAULT 'unknown',
  last_health_check TEXT,
  total_requests INTEGER DEFAULT 0,
  total_cost REAL DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

### 2. learning_concepts
Stores learning concepts that users can pursue simultaneously.

```sql
CREATE TABLE learning_concepts (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL,
  difficulty TEXT NOT NULL,
  estimated_hours INTEGER,
  prerequisites TEXT, -- JSON array
  learning_objectives TEXT, -- JSON array
  custom_prompts TEXT, -- JSON array
  is_active BOOLEAN DEFAULT true,
  completion_percentage REAL DEFAULT 0,
  current_module TEXT,
  time_spent REAL DEFAULT 0,
  last_studied TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

### 3. context_embeddings
Stores vector embeddings for semantic context retrieval.

```sql
CREATE TABLE context_embeddings (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  concept_id TEXT REFERENCES learning_concepts(id) ON DELETE CASCADE,
  conversation_id TEXT REFERENCES conversations(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  embedding BLOB, -- Vector embedding
  metadata TEXT, -- JSON metadata
  relevance_score REAL,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### 4. learning_plans
Stores personalized learning plans generated by AI.

```sql
CREATE TABLE learning_plans (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  concepts TEXT NOT NULL, -- JSON array of concept configurations
  schedule TEXT, -- JSON schedule configuration
  adaptive_settings TEXT, -- JSON adaptive learning settings
  is_active BOOLEAN DEFAULT true,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

### 5. ai_request_logs
Logs all AI requests for monitoring and cost tracking.

```sql
CREATE TABLE ai_request_logs (
  id TEXT PRIMARY KEY,
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  conversation_id TEXT REFERENCES conversations(id) ON DELETE CASCADE,
  concept_id TEXT REFERENCES learning_concepts(id) ON DELETE CASCADE,
  provider TEXT NOT NULL,
  model TEXT NOT NULL,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  total_tokens INTEGER,
  cost REAL,
  response_time INTEGER, -- milliseconds
  success BOOLEAN DEFAULT true,
  error_message TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

## Enhanced Existing Tables

### conversations table - New columns:
- `concept_id` - Links conversation to a learning concept
- `ai_provider` - Tracks which AI provider was used
- `context_summary` - Stores compressed context summary
- `total_cost` - Tracks total cost for the conversation

### messages table - New columns:
- `concept_id` - Links message to a learning concept
- `context_used` - JSON metadata about context used
- `cost` - Cost for this specific message
- `processing_time` - Processing time in milliseconds

## Indexes Added

Performance indexes for efficient querying:

```sql
-- AI Providers indexes
CREATE INDEX idx_ai_providers_type ON ai_providers (type);
CREATE INDEX idx_ai_providers_enabled ON ai_providers (enabled);
CREATE INDEX idx_ai_providers_priority ON ai_providers (priority);

-- Learning Concepts indexes
CREATE INDEX idx_learning_concepts_user_id ON learning_concepts (user_id);
CREATE INDEX idx_learning_concepts_category ON learning_concepts (category);
CREATE INDEX idx_learning_concepts_is_active ON learning_concepts (is_active);
CREATE INDEX idx_learning_concepts_last_studied ON learning_concepts (last_studied);

-- Context Embeddings indexes
CREATE INDEX idx_context_embeddings_user_id ON context_embeddings (user_id);
CREATE INDEX idx_context_embeddings_concept_id ON context_embeddings (concept_id);
CREATE INDEX idx_context_embeddings_conversation_id ON context_embeddings (conversation_id);
CREATE INDEX idx_context_embeddings_relevance_score ON context_embeddings (relevance_score);

-- Learning Plans indexes
CREATE INDEX idx_learning_plans_user_id ON learning_plans (user_id);
CREATE INDEX idx_learning_plans_is_active ON learning_plans (is_active);

-- AI Request Logs indexes
CREATE INDEX idx_ai_request_logs_user_id ON ai_request_logs (user_id);
CREATE INDEX idx_ai_request_logs_conversation_id ON ai_request_logs (conversation_id);
CREATE INDEX idx_ai_request_logs_concept_id ON ai_request_logs (concept_id);
CREATE INDEX idx_ai_request_logs_provider ON ai_request_logs (provider);
CREATE INDEX idx_ai_request_logs_created_at ON ai_request_logs (created_at);
CREATE INDEX idx_ai_request_logs_success ON ai_request_logs (success);

-- Enhanced indexes for existing tables
CREATE INDEX idx_conversations_concept_id ON conversations (concept_id);
CREATE INDEX idx_conversations_ai_provider ON conversations (ai_provider);
CREATE INDEX idx_messages_concept_id ON messages (concept_id);
CREATE INDEX idx_messages_cost ON messages (cost);
```

## TypeScript Types Added

New TypeScript types exported from schema.ts:

```typescript
export type AIProvider = typeof aiProviders.$inferSelect;
export type NewAIProvider = typeof aiProviders.$inferInsert;
export type LearningConcept = typeof learningConcepts.$inferSelect;
export type NewLearningConcept = typeof learningConcepts.$inferInsert;
export type ContextEmbedding = typeof contextEmbeddings.$inferSelect;
export type NewContextEmbedding = typeof contextEmbeddings.$inferInsert;
export type LearningPlan = typeof learningPlans.$inferSelect;
export type NewLearningPlan = typeof learningPlans.$inferInsert;
export type AIRequestLog = typeof aiRequestLogs.$inferSelect;
export type NewAIRequestLog = typeof aiRequestLogs.$inferInsert;
```

## Migration Files Created

1. `0002_lowly_photon.sql` - Main migration with new tables and column additions
2. `0003_add_multi_ai_indexes.sql` - Performance indexes for all new tables

## Seed Data Enhancement

Updated seed script to include default AI providers:
- OpenAI GPT-4
- Claude 3.5 Sonnet
- Gemini Pro
- Ollama Llama 3.1 (disabled by default)
- Mistral Large

## Requirements Satisfied

This implementation satisfies the following requirements:

- **Requirement 2.2**: Multiple Learning Concept Support - `learning_concepts` table with progress tracking
- **Requirement 2.3**: Enhanced conversation and message tracking with concept linking
- **Requirement 5.1**: Context storage with `context_embeddings` table for vector-based retrieval
- **Requirement 5.5**: AI provider management with `ai_providers` table and request logging

## Next Steps

1. Implement service classes to interact with these new tables
2. Create AI provider management system
3. Build context management and embedding generation
4. Implement learning concept CRUD operations
5. Add learning plan generation functionality

## Files Modified

- `src/lib/database/schema.ts` - Added new tables and enhanced existing ones
- `src/lib/database/seed.ts` - Added AI provider seeding
- `src/lib/database/migrations/0002_lowly_photon.sql` - Generated migration
- `src/lib/database/migrations/0003_add_multi_ai_indexes.sql` - Manual index migration

## Database Status

✅ All new tables created successfully
✅ All new columns added to existing tables
✅ All indexes created for performance optimization
✅ Foreign key relationships established
✅ TypeScript types generated and exported
✅ Seed data updated with default AI providers